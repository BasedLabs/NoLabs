<!DOCTYPE html>
<html>
<head>
    <style>
        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body>
<img id="img" src="./static/images/original.png"
     width="500" style="height: auto">
<canvas id="highlightCanvas" width="500" height="500"></canvas>
<script>
    window.onmousemove = function (e) {
        console.log("mouse location:", e.clientX, e.clientY)
    };
    var img = document.getElementById('originalImg');
    var canvas = document.getElementById('highlightCanvas');
    var ctx = canvas.getContext('2d');

    const localisation = function () {
        const _createImage = (src) => {
            const image = new Image(500, 500);
            image.src = src;
            return image;
        };
        return {
            highlightData: {
                mithochondria: {
                    image: _createImage('./static/images/mithochondria.png'),
                    polygon: [
                        [
                            [150, 115],
                            [182, 112],
                            [217, 139],
                            [210, 155],
                            [180, 143],
                            [156, 149]
                        ],
                        [
                            [213, 352],
                            [234, 345],
                            [250, 353],
                            [242, 385],
                            [200, 390],
                            [182, 377],
                            [178, 353],
                            [192, 345],
                        ]
                    ]
                },
                nucleus: {
                    image: _createImage('./static/images/nucleus.png'),
                    polygon: [
                       [ [176, 178],
                        [202, 199],
                        [222, 229],
                        [216, 257],
                        [170, 271],
                        [134, 255],
                        [137, 201],
                        [169, 177]]
                    ]
                },
                cytoplasm: {
                    image: _createImage('./static/images/cytoplasm.png'),
                    polygon: [
                        [[95, 160],
                        [190, 99],
                        [238, 167],
                        [341, 203],
                        [400, 313],
                        [332, 385],
                        [160, 381],
                        [88, 315],
                        [82, 201],
                        [130, 107]]
                    ]
                },
                original: {
                    image: _createImage('./static/images/original.png'),
                    polygon: [
                        [[0,0],
                        [500,0],
                        [500,500],
                        [0,500]]
                    ]
                },
            },
            isInside: function inside(point, vsArray) {
                for (const vs of vsArray) {
                    // ray-casting algorithm based on
                    // https://wrf.ecse.rpi.edu/Research/Short_Notes/pnpoly.html

                    const x = point[0], y = point[1];

                    let inside = false;
                    for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
                        let xi = vs[i][0], yi = vs[i][1];
                        let xj = vs[j][0], yj = vs[j][1];

                        let intersect = ((yi > y) != (yj > y))
                            && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                        if (intersect) inside = !inside;
                    }

                    if (inside)
                        return true;
                }
                return false;
            }
        }
    }

    const localisationManager = localisation();

    canvas.addEventListener('mousemove', function (event) {
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        for (const key in localisationManager.highlightData) {
            const data = localisationManager.highlightData[key];
            if (localisationManager.isInside([x, y], data.polygon)) {
                document.getElementById('img').src = data.image.src;
                return;
            }
        }
    });

    canvas.addEventListener('mouseout', function () {
        document.getElementById('img').src = localisationManager.highlightData.original.image.src;
    });
</script>
</body>
</html>
